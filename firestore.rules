
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy: This ruleset implements a sophisticated security model that combines
     * strict user-ownership with a hierarchical Role-Based Access Control (RBAC) system.
     * A key change is the move to a top-level `/submissions` collection to simplify
     * supervisory queries. The default posture remains denial of access, with permissions
     * explicitly granted based on user identity and assigned roles.
     *
     * Data Structure: User profiles are stored in `/users/{userId}`. All submissions from all
     * users are stored in the global `/submissions/{submissionId}` collection. This flat
     * structure is efficient for admin/supervisor queries. Security is maintained by
     * embedding ownership and context fields (userId, campusId, unitId) directly into each
     * submission document.
     *
     * Key Security Decisions:
     * - User Listing Disabled: To protect user privacy, listing the top-level `/users`
     *   collection is explicitly forbidden except for Admins.
     * - Role-Based Access via Existence Checks: A user's role is determined by checking for the
     *   existence of a document in collections like `/roles_admin/{userId}`.
     * - Read-Only Global Data: Core application data (roles, campuses, etc.) is readable by any
     *   signed-in user but is only writable by Admins, ensuring data integrity.
     * - Top-Level Submissions: This collection is readable by a user if they are the owner OR
     *   if they are a supervisor for the submission's campus/unit. Writes are strictly
     *   controlled to the document owner.
     *
     * Denormalization for Authorization: The rules for accessing the `/submissions` collection
     * rely heavily on the assumption that `Submission` documents contain denormalized `campusId`
     * and `unitId` fields. This avoids slow and costly cross-collection `get()` calls in
     * security rules when evaluating list queries for supervisors, which is a critical
     * performance and security best practice.
     */

    // --------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user is the owner of a document,
     * based on a matching userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the currently authenticated user has global Admin privileges.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    /**
     * Checks if the current user has Campus ODIMO privileges.
     */
    function isCampusOdimo() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_campus_odimo/$(request.auth.uid));
    }

    /**
     * Checks if the current user has Campus Director privileges.
     * Note: Campus Directors are a type of Campus ODIMO but with more permissions.
     */
    function isCampusDirector() {
        return getUserProfile().role == 'Campus Director';
    }
    
    /**
     * Checks if the current user has Unit ODIMO privileges.
     */
    function isUnitOdimo() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_unit_odimo/$(request.auth.uid));
    }
    
    /**
     * Retrieves the user's profile data. CRITICAL: This function requires that a
     * document for the currently authenticated user exists at /users/$(request.auth.uid).
     * If the document is missing, any rule calling this function will fail.
     */
    function getUserProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }


    // --------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------
    
    /**
     * @description Users can read, create, and update their own profile. Admins can read/write any profile.
     * Supervisors can list users within their scope.
     * The `get` rule is critical for the `getUserProfile()` helper to function.
     */
    match /users/{userId} {
      allow get: if isSignedIn();
      allow update: if isOwner(userId) || isAdmin();
      allow list: if isSignedIn(); // Allow any signed-in user to list/query users. Filtering is done client-side.
      allow create: if isOwner(userId); // A user can create their own document.
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    /**
     * @description Top-level submissions collection.
     * - Read: Allowed if you are the owner OR an authorized supervisor for the submission's campus/unit.
     * - Create: Allowed only if you are the owner and the submission data is valid.
     * - Update: Allowed for owners or supervisors.
     * - Delete: Only allowed for owners.
     */
    match /submissions/{submissionId} {
      allow get: if isOwner(resource.data.userId) 
                    || (isCampusOdimo() && getUserProfile().campusId == resource.data.campusId) 
                    || (isUnitOdimo() && getUserProfile().unitId == resource.data.unitId) 
                    || isAdmin();
      allow list: if isSignedIn(); // Further filtering must be done in the query.
      
      allow create: if isOwner(request.resource.data.userId)
                    && 'campusId' in getUserProfile() && 'unitId' in getUserProfile()
                    && request.resource.data.campusId == getUserProfile().campusId
                    && request.resource.data.unitId == getUserProfile().unitId;

      allow update: if isOwner(resource.data.userId) || (isCampusOdimo() && getUserProfile().campusId == resource.data.campusId) || (isUnitOdimo() && getUserProfile().unitId == resource.data.unitId) || isAdmin();

      allow delete: if isOwner(resource.data.userId);
    }

    /**
     * @description Global role definitions are readable by any authenticated user but only managed by Admins.
     */
    match /roles/{roleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Global submission statuses are readable by any authenticated user but only managed by Admins.
     */
    match /submissionStatuses/{statusId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    /**
     * @description Global submission cycles are readable by any authenticated user but only managed by Admins.
     */
    match /cycles/{cycleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    /**
     * @description Global campus definitions are readable by any authenticated user but only managed by Admins.
     */
    match /campuses/{campusId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    /**
     * @description Campus-specific settings can be managed by campus-level users or admins.
     */
    match /campusSettings/{campusId} {
      allow get: if isSignedIn() && getUserProfile().campusId == campusId;
      allow write: if isAdmin() || (isCampusOdimo() && getUserProfile().campusId == campusId);
      allow list: if isAdmin();
    }
    
    /**
     * @description Unit definitions are readable by anyone.
     * Creation is allowed for Admins or Campus Directors (for their own campus).
     * Updates are allowed for Admins or Campus Directors assigning/un-assigning a unit to their campus.
     */
    match /units/{unitId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin() || 
                       (isCampusDirector() && request.resource.data.campusIds.hasOnly([getUserProfile().campusId]));
      allow update: if isAdmin() || 
                       (isCampusDirector() && request.resource.data.campusIds.hasAny([getUserProfile().campusId]));
      allow delete: if isAdmin();
    }
    
    /**
     * @description The collection for assigning Admin roles. Only other Admins can manage this list.
     */
    match /roles_admin/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description The collection for assigning Campus ODIMO roles. Only Admins can manage this list.
     */
    match /roles_campus_odimo/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }

    /**

     * @description The collection for assigning Unit ODIMO roles. Only Admins can manage this list.
     */
    match /roles_unit_odimo/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }
  }
}
