
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Helper Functions
     */
    function isSignedIn() {
      return request.auth != null;
    }

    function hasProfile() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function profile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    /**
     * Master Admin Check
     * Checks both the dedicated admin collection and the role string.
     */
    function isAdmin() {
      return isSignedIn() && (
        exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid)) ||
        (hasProfile() && profile().get('role', '').matches('(?i).*admin.*'))
      );
    }

    function isAuditor() {
      return isSignedIn() && hasProfile() && profile().get('role', '').matches('(?i).*auditor.*');
    }

    // --------------------------------------------------------------------------
    // CORE COLLECTION: unitMonitoringRecords
    // --------------------------------------------------------------------------
    match /unitMonitoringRecords/{recordId} {
        
        // 1. Master Admin and Auditors can see everything (Global Scope)
        allow get, list: if isAdmin() || isAuditor();
        
        // 2. Campus Officials (Director, Odimos, VP) see their campus
        allow get, list: if isSignedIn() && hasProfile() && (
          resource.data.campusId == profile().get('campusId', '') && 
          profile().get('role', '').matches('(?i).*(director|odimo|vice president).*')
        );

        // 3. Unit Users see their unit
        allow get, list: if isSignedIn() && hasProfile() && (
          resource.data.unitId == profile().get('unitId', '') &&
          !profile().get('role', '').matches('(?i).*(director|odimo|vice president|admin|auditor).*')
        );

        // 4. Write Rules (ENFORCE DATA INTEGRITY)
        // Admins can write anything. Campus ODIMOs can write/update records for their own campus.
        allow create: if (isAdmin() || (isSignedIn() && hasProfile() && profile().get('role', '') == 'Campus ODIMO' && request.resource.data.campusId == profile().get('campusId', ''))) && 
          request.resource.data.keys().hasAll(['unitId', 'campusId']);
        
        allow update: if isAdmin() || (isSignedIn() && hasProfile() && profile().get('role', '') == 'Campus ODIMO' && resource.data.campusId == profile().get('campusId', ''));
        
        allow delete: if isAdmin();
    }

    // --------------------------------------------------------------------------
    // EOMS COLLECTIONS
    // --------------------------------------------------------------------------

    match /academicPrograms/{programId} {
        allow read: if isSignedIn();
        allow write: if isAdmin() || (isSignedIn() && hasProfile() && (
          profile().get('role', '').matches('(?i).*director.*') || 
          profile().get('role', '').matches('(?i).*odimo.*')
        ));
    }

    match /programCompliances/{recordId} {
        allow read: if isSignedIn();
        allow write: if isAdmin() || (isSignedIn() && hasProfile() && (
          profile().get('role', '').matches('(?i).*director.*') || 
          profile().get('role', '').matches('(?i).*odimo.*') ||
          (profile().get('campusId', '') == (request.resource.data.campusId || resource.data.campusId) && profile().get('role', '').matches('(?i).*coordinator.*'))
        ));
    }

    match /users/{userId} {
      allow read: if isSignedIn();
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if (isSignedIn() && request.auth.uid == userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    match /roles_admin/{userId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /submissions/{submissionId} {
      allow read: if isAdmin() || isAuditor();
      allow read: if isSignedIn() && hasProfile() && (
        resource.data.userId == request.auth.uid || 
        resource.data.unitId == profile().get('unitId', '') || 
        resource.data.campusId == profile().get('campusId', '') ||
        profile().get('role', '').matches('(?i).*(vice president|director|odimo|admin).*')
      );
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin() || (isSignedIn() && hasProfile() && (
        resource.data.userId == request.auth.uid || 
        resource.data.unitId == profile().get('unitId', '') || 
        resource.data.campusId == profile().get('campusId', '')
      ));
      allow delete: if isAdmin();
    }

    match /risks/{riskId} {
      allow read: if isAdmin() || isAuditor();
      allow read: if isSignedIn() && hasProfile() && (
        resource.data.unitId == profile().get('unitId', '') ||
        resource.data.userId == request.auth.uid ||
        resource.data.campusId == profile().get('campusId', '') ||
        profile().get('role', '').matches('(?i).*(vice president|director|odimo|admin).*')
      );
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow update: if isAdmin() || (isSignedIn() && hasProfile() && (
        request.auth.uid == resource.data.userId || 
        profile().get('unitId', '') == resource.data.unitId
      ));
      allow delete: if isAdmin();
    }

    match /appFeedbacks/{feedbackId} {
      allow create: if isSignedIn();
      allow read: if isAdmin();
    }

    match /softwareEvaluations/{evalId} {
      // Evaluation is now public for creation
      allow create: if true;
      // Only Admins can see the results
      allow read: if isAdmin();
    }

    match /roles/{roleId} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /cycles/{cycleId} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /campuses/{campusId} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /units/{unitId} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /activityLogs/{logId} { allow read: if isAdmin(); allow create: if isSignedIn(); }
    match /errorReports/{errorId} { allow create: if isSignedIn(); allow read, update, delete: if isAdmin(); }
    match /procedureManuals/{unitId} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /eomsPolicyManuals/{docId} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /isoClauses/{clauseId} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /auditPlans/{planId} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /auditSchedules/{scheduleId} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /auditFindings/{findingId} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    match /correctiveActionPlans/{planId} { allow read: if isSignedIn(); allow write: if isAdmin(); }
    
    match /campusSettings/{settingId} {
      allow read: if isSignedIn();
      allow write: if isAdmin() || (isSignedIn() && hasProfile() && (
        profile().get('role', '').matches('(?i).*(director|odimo|admin|vice president).*') &&
        (settingId == profile().get('campusId', '') || settingId == 'global')
      ));
    }
  }
}
