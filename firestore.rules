
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy: This ruleset uses a token-based Role-Based Access Control (RBAC) system.
     * Permissions are granted based on custom claims (role, campusId) embedded in the user's
     * Firebase Authentication ID token. This is more secure and performant than reading from
     * the database in rules. The default posture is to deny all access.
     */

    // --------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }
    
    function hasToken() {
        return request.auth.token != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }
    
    function hasRole(roleName) {
        return hasToken() && request.auth.token.role == roleName;
    }
    
    function hasAnyRole(roles) {
        return hasToken() && request.auth.token.role in roles;
    }
    
    function isAdmin() {
        return hasRole('Admin');
    }

    // --------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------

    match /users/{userId} {
      // Any signed-in user can get a user profile (needed for names, etc.)
      allow get: if isSignedIn();
      // Any signed-in user can list users (client-side filtering applies)
      allow list: if isSignedIn();
      // Only the user themselves can create their own document.
      allow create: if isOwner(userId);
      // Only the user or an admin can update a profile.
      allow update: if isOwner(userId) || isAdmin();
      // Only the user or an admin can delete a profile.
      allow delete: if isOwner(userId) || isAdmin();
    }

    match /submissions/{submissionId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isOwner(request.resource.data.userId);
        allow update: if isAdmin()
            || isOwner(resource.data.userId)
            || hasAnyRole(['Campus ODIMO', 'Unit ODIMO', 'Campus Director', 'Vice President']);
        allow delete: if isAdmin() || isOwner(resource.data.userId);
    }
    
    match /risks/{riskId} {
        allow get: if isSignedIn();
        allow list: if isSignedIn();
        allow create: if isSignedIn();
        allow update, delete: if isOwner(request.resource.data.userId) || hasAnyRole(['Unit ODIMO']) || isAdmin();
    }
    
    match /roles/{roleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    match /submissionStatuses/{statusId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    match /cycles/{cycleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    match /campuses/{campusId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    match /campusSettings/{campusId} {
      allow get: if isSignedIn();
      allow list: if isAdmin();
      allow write: if isAdmin() || hasRole('Campus ODIMO') || hasRole('Campus Director');
    }
    
    match /units/{unitId} {
        allow get, list: if isSignedIn();
        
        allow create: if isAdmin() || hasRole('Campus Director');

        // This rule allows updates only if the user is an admin or a VP,
        // OR if they are a Campus Director AND they are ONLY changing the campusIds field.
        allow update: if isAdmin() 
            || hasRole('Vice President')
            || (
                hasRole('Campus Director') &&
                request.resource.data.diff(resource.data).affectedKeys().hasOnly(["campusIds"])
            );
        
        allow delete: if isAdmin()
            || (
                hasRole('Campus Director') &&
                resource.data.campusIds.size() == 1 &&
                resource.data.campusIds[0] == request.auth.token.campusId
            );
    }


    match /activityLogs/{logId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read, list, update, delete: if isAdmin();
    }
    
    match /errorReports/{errorId} {
        allow create: if isSignedIn();
        allow read, list, update, delete: if isAdmin();
    }

    match /roles_admin/{userId} {
      allow get: if isSignedIn();
      allow list, write: if isAdmin();
    }
  }
}
