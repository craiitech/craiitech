
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy: This ruleset implements a sophisticated security model that combines
     * strict user-ownership with a hierarchical Role-Based Access Control (RBAC) system.
     * A key change is the move to a top-level /submissions collection to simplify
     * supervisory queries. The default posture remains denial of access, with permissions
     * explicitly granted based on user identity and assigned roles.
     *
     * Data Structure: User profiles are stored in /users/{userId}. All submissions from all
     * users are stored in the global /submissions/{submissionId} collection. This flat
     * structure is efficient for admin/supervisor queries. Security is maintained by
     * embedding ownership and context fields (userId, campusId, unitId) directly into each
     * submission document.
     *
     * Key Security Decisions:
     * - User profiles are readable by any signed-in user to support application functionality.
     * - Role-Based Access via Existence Checks: A user's role is determined by checking for the
     *   existence of a document in collections like /roles_admin/{userId}.
     * - Read-Only Global Data: Core application data (roles, campuses, etc.) is readable by any
     *   signed-in user but is only writable by Admins, ensuring data integrity.
     * - Top-Level Submissions: This collection is readable by a user if they are the owner OR
     *   if they are a supervisor for the submission's campus/unit.
     *
     * Denormalization for Authorization: The rules for accessing the /submissions collection
     * rely heavily on the assumption that Submission documents contain denormalized campusId
     * and unitId fields. This avoids slow and costly cross-collection get() calls in
     * security rules when evaluating list queries for supervisors, which is a critical
     * performance and security best practice.
     */

    // --------------------------------------------------------------------------
    // Helper Functions
    // --------------------------------------------------------------------------

    /**
     * Checks if a user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the currently authenticated user is the owner of a document,
     * based on a matching userId.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the currently authenticated user has global Admin privileges.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }
    
    /**
     * Checks if the current user has Campus ODIMO privileges.
     */
    function isCampusOdimo() {
      return isSignedIn() && getUserProfile().role == 'Campus ODIMO';
    }

    /**
     * Checks if the current user has Campus Director privileges.
     * Note: Campus Directors are a type of Campus ODIMO but with more permissions.
     */
    function isCampusDirector() {
        return getUserProfile().role == 'Campus Director';
    }
    
    /**
     * Checks if the current user has Unit ODIMO privileges.
     */
    function isUnitOdimo() {
      return isSignedIn() && getUserProfile().role == 'Unit ODIMO';
    }

    /**
     * Checks if the current user has Auditor privileges.
     */
    function isAuditor() {
      return isSignedIn() && getUserProfile().role == 'Auditor';
    }

    /**
     * Checks if the current user has Vice President privileges by checking if their role name contains "Vice President".
     */
    function isVicePresident() {
        return isSignedIn() && getUserProfile().role.matches("Vice President");
    }
    
    /**
     * Retrieves the user's profile data. CRITICAL: This function requires that a
     * document for the currently authenticated user exists at /users/$(request.auth.uid).
     * If the document is missing, any rule calling this function will fail.
     */
    function getUserProfile() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }


    // --------------------------------------------------------------------------
    // Collection Rules
    // --------------------------------------------------------------------------
    
    /**
     * @description Users can read, create, and update their own profile. Admins can read/write any profile.
     * The `get` rule is critical for the `getUserProfile()` helper to function.
     * The `list` rule is allowed for signed-in users to support client-side queries and filtering.
     */
    match /users/{userId} {
      allow get, list: if isSignedIn();
      allow update: if isOwner(userId) || isAdmin();
      allow create: if isOwner(userId); // A user can create their own document.
      allow delete: if isOwner(userId) || isAdmin();
    }
    
    /**
     * @description Top-level submissions collection.
     * - get: Allowed if you are the owner, an authorized supervisor, or an admin.
     * - list: Allowed for signed-in users. Security is enforced by client-side queries and the 'get' rule.
     * - create/update/delete: Secured by ownership or role.
     */
    match /submissions/{submissionId} {
      allow get: if isAdmin()
                    || isOwner(resource.data.userId) 
                    || (isCampusOdimo() && getUserProfile().campusId == resource.data.campusId) 
                    || (isUnitOdimo() && getUserProfile().unitId == resource.data.unitId)
                    || (isCampusDirector() && getUserProfile().campusId == resource.data.campusId)
                    || (isVicePresident() && get(/databases/$(database)/documents/units/$(resource.data.unitId)).data.campusIds.hasAny(getUserProfile().campusIds));
      
      allow list: if isSignedIn();

      allow create: if isOwner(request.resource.data.userId)
                    && 'campusId' in getUserProfile() && 'unitId' in getUserProfile()
                    && request.resource.data.campusId == getUserProfile().campusId
                    && request.resource.data.unitId == getUserProfile().unitId;

      allow update: if isAdmin()
                    || isOwner(resource.data.userId) 
                    || (isCampusOdimo() && getUserProfile().campusId == resource.data.campusId) 
                    || (isUnitOdimo() && getUserProfile().unitId == resource.data.unitId)
                    || (isCampusDirector() && getUserProfile().campusId == resource.data.campusId)
                    || (isVicePresident() && get(/databases/$(database)/documents/units/$(resource.data.unitId)).data.campusIds.hasAny(getUserProfile().campusIds));

      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }

    /**
     * @description Top-level risk register collection.
     * - get: Allowed if user is from the same unit, a supervisor, or an admin.
     * - list: Secured. Client must provide a `where` clause on campusId or unitId.
     * - create/update/delete: Allowed for users of the same unit or admins.
     */
    match /risks/{riskId} {
      allow get: if isAdmin()
                    || (getUserProfile().unitId == resource.data.unitId)
                    || (isCampusOdimo() && getUserProfile().campusId == resource.data.campusId) 
                    || (isUnitOdimo() && getUserProfile().unitId == resource.data.unitId)
                    || (isCampusDirector() && getUserProfile().campusId == resource.data.campusId)
                    || (isVicePresident() && get(/databases/$(database)/documents/units/$(resource.data.unitId)).data.campusIds.hasAny(getUserProfile().campusIds));
      
      allow list: if isSignedIn();

      allow create: if request.resource.data.unitId == getUserProfile().unitId
                    && request.resource.data.campusId == getUserProfile().campusId;
      
      allow update, delete: if (getUserProfile().unitId == resource.data.unitId) || isAdmin();
    }

    /**
     * @description Global role definitions are readable by any authenticated user but only managed by Admins.
     */
    match /roles/{roleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }

    /**
     * @description Global submission statuses are readable by any authenticated user but only managed by Admins.
     */
    match /submissionStatuses/{statusId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    /**
     * @description Global submission cycles are readable by any authenticated user but only managed by Admins.
     */
    match /cycles/{cycleId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    /**
     * @description Global campus definitions are readable by any authenticated user but only managed by Admins.
     */
    match /campuses/{campusId} {
      allow get, list: if isSignedIn();
      allow create, update, delete: if isAdmin();
    }
    
    /**
     * @description Campus-specific settings can be managed by campus-level users or admins.
     * Any signed-in user can read announcements for their campus or global announcements.
     */
    match /campusSettings/{campusId} {
      allow get: if (isSignedIn() && (getUserProfile().campusId == campusId || campusId == 'global')) || isAdmin();
      allow write: if isAdmin() || (isCampusDirector() && getUserProfile().campusId == campusId) || (isCampusOdimo() && getUserProfile().campusId == campusId);
      allow list: if isAdmin();
    }
    
    /**
     * @description Unit definitions are readable by anyone.
     * Creation is allowed for Admins or Campus Directors (for their own campus).
     * Updates are allowed for Admins or Campus Directors assigning/un-assigning a unit to their campus.
     */
    match /units/{unitId} {
      allow get, list: if isSignedIn();
      allow create: if isAdmin() || 
                       (isCampusDirector() && request.resource.data.campusIds.hasOnly([getUserProfile().campusId]));
      allow update: if isAdmin() || 
                       (isCampusDirector() && request.resource.data.campusIds.hasAny([getUserProfile().campusId])) ||
                       isVicePresident();
      allow delete: if isAdmin();
    }

    /**
     * @description Activity logs for auditing.
     * - Create: Any signed-in user can create a log entry for their own actions.
     * - Read/List: Only Admins can read or list logs.
     * - Update/Delete: No one can modify or delete logs to ensure audit trail integrity.
     */
    match /activityLogs/{logId} {
      allow create: if isSignedIn() && request.resource.data.userId == request.auth.uid;
      allow read, list: if isAdmin();
      allow update, delete: if false;
    }
    
    /**
     * @description Error reports submitted by users.
     * - Create: Any signed-in user can create an error report.
     * - Read/List: Only Admins can read the reports.
     * - Update/Delete: Only Admins can update (e.g., change status) or delete reports.
     */
    match /errorReports/{errorId} {
        allow create: if isSignedIn();
        allow read, list, update, delete: if isAdmin();
    }

    /**
     * @description The collection for assigning Admin roles. Only other Admins can manage this list.
     */
    match /roles_admin/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create, update, delete: if isAdmin();
    }
    
    match /procedureManuals/{document=**} {
      allow read, list: if isSignedIn();
    }

    match /procedureManuals/{unitId} {
      allow write: if isAdmin();
    }

    /**
     * @description ISO Clauses are read-only for all signed-in users, writable only by Admins.
     */
    match /isoClauses/{clauseId} {
        allow get, list: if isSignedIn();
        allow write: if isAdmin();
    }

    /**
     * @description Audit Plans can be created and managed by Admins. They are readable by Admins and Auditors.
     */
    match /auditPlans/{planId} {
        allow read, list: if isAdmin() || isAuditor();
        allow write: if isAdmin();
    }

    /**
     * @description Audit Schedules can be created/managed by Admins. Auditors can read/update schedules. Auditees can read schedules targeting them.
     */
    match /auditSchedules/{scheduleId} {
        allow get: if isAdmin() 
                    || isAuditor()
                    || (resource.data.targetType == 'Unit' && getUserProfile().unitId == resource.data.targetId)
                    || (resource.data.targetType == 'User' && isOwner(resource.data.targetId));
        allow list: if isAdmin() || isAuditor() || (request.query.limit <= 10 && request.query.targetId == getUserProfile().unitId);
        allow create: if isAdmin();
        allow update: if isAdmin() || (isAuditor() && resource.data.auditorId == null); // Allow auditor to claim an unassigned audit
    }

    /**
     * @description Audit Findings can be created by the assigned auditor. They can be read by the auditor, the auditee, and admins/supervisors.
     */
    match /auditFindings/{findingId} {
        allow get: if isAdmin() 
                    || isAuditor()
                    || (get(/databases/$(database)/documents/auditSchedules/$(resource.data.auditScheduleId)).data.targetType == 'Unit' && getUserProfile().unitId == get(/databases/$(database)/documents/auditSchedules/$(resource.data.auditScheduleId)).data.targetId)
                    || (get(/databases/$(database)/documents/auditSchedules/$(resource.data.auditScheduleId)).data.targetType == 'User' && isOwner(get(/databases/$(database)/documents/auditSchedules/$(resource.data.auditScheduleId)).data.targetId));
        allow list: if isSignedIn();
        allow create: if isAuditor() && get(/databases/$(database)/documents/auditSchedules/$(request.resource.data.auditScheduleId)).data.auditorId == request.auth.uid;
        allow update: if isAuditor() && isOwner(resource.data.authorId);
        allow delete: if isAdmin();
    }

     /**
     * @description Corrective Action Plans can be created by the auditee. They are readable by the auditee, auditor, and admins.
     */
    match /correctiveActionPlans/{planId} {
        allow get: if isAdmin()
                    || isAuditor()
                    || isOwner(resource.data.authorId);
        allow list: if isSignedIn();
        allow create: if isOwner(request.resource.data.authorId);
        allow update: if isOwner(resource.data.authorId) || isAdmin();
        allow delete: if isAdmin();
    }
  }
}

    