
{
  "entities": {
    "User": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "User",
      "type": "object",
      "description": "Represents a user within the RSU EOMS Submission Portal.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the User entity."
        },
        "email": {
          "type": "string",
          "description": "User's email address.",
          "format": "email"
        },
        "firstName": {
          "type": "string",
          "description": "User's first name."
        },
        "lastName": {
          "type": "string",
          "description": "User's last name."
        },
        "roleId": {
          "type": "string",
          "description": "Reference to Role. (Relationship: User 1:1 Role)"
        },
        "role": {
          "type": "string",
          "description": "The name of the user's role, denormalized for easy access."
        },
        "campusId": {
          "type": "string",
          "description": "Reference to Campus. (Relationship: User 1:1 Campus).  The campus the user belongs to."
        },
        "unitId": {
          "type": "string",
          "description": "Reference to Unit. (Relationship: User 1:1 Unit). The unit the user belongs to."
        },
        "verified": {
          "type": "boolean",
          "description": "Indicates if the user's account has been verified by an admin."
        }
      },
      "required": [
        "id",
        "email",
        "firstName",
        "lastName",
        "roleId",
        "role",
        "campusId",
        "unitId",
        "verified"
      ]
    },
    "Role": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Role",
      "type": "object",
      "description": "Represents a user role within the system (e.g., Admin, Campus Director).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Role entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the role (e.g., Admin, Campus Director)."
        },
        "description": {
          "type": "string",
          "description": "Description of the role and its permissions."
        }
      },
      "required": [
        "id",
        "name",
        "description"
      ]
    },
    "Submission": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Submission",
      "type": "object",
      "description": "Represents a report submission by an employee.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Submission entity."
        },
        "userId": {
          "type": "string",
          "description": "Reference to User. (Relationship: User 1:N Submission).  The user who submitted the report."
        },
        "submissionDate": {
          "type": "string",
          "description": "Date and time of the submission.",
          "format": "date-time"
        },
        "googleDriveLink": {
          "type": "string",
          "description": "Link to the report on Google Drive.",
          "format": "uri"
        },
        "cycleId": {
          "type": "string",
          "description": "Reference to Cycle. (Relationship: Submission 1:1 Cycle). Identifies the submission cycle (First or Final)."
        },
        "statusId": {
          "type": "string",
          "description": "Reference to SubmissionStatus. (Relationship: Submission 1:1 SubmissionStatus). Current status of the submission in the approval workflow."
        },
        "comments": {
            "type": "array",
            "description": "A list of comments forming a conversation thread about the submission.",
            "items": { "$ref": "#/backend/entities/Comment" }
        },
        "reportType": {
          "type": "string",
          "description": "The type of report being submitted (e.g., Operational Plans)."
        },
        "year": {
          "type": "number",
          "description": "The year the report corresponds to."
        },
        "unitName": {
          "type": "string",
          "description": "The denormalized name of the unit for easier display."
        },
        "campusId": {
          "type": "string",
          "description": "The denormalized ID of the campus for easier querying."
        },
        "unitId": {
            "type": "string",
            "description": "The denormalized ID of the unit for easier querying."
        }
      },
      "required": [
        "id",
        "userId",
        "submissionDate",
        "googleDriveLink",
        "cycleId",
        "statusId",
        "reportType",
        "year",
        "unitName",
        "campusId",
        "unitId"
      ]
    },
     "Comment": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Comment",
      "type": "object",
      "description": "Represents a single comment in a submission's conversation thread.",
      "properties": {
        "text": {
          "type": "string",
          "description": "The content of the comment."
        },
        "authorId": {
          "type": "string",
          "description": "The UID of the user who wrote the comment."
        },
        "authorName": {
            "type": "string",
            "description": "The denormalized name of the author."
        },
         "authorRole": {
            "type": "string",
            "description": "The denormalized role of the author at the time of commenting."
        },
        "createdAt": {
          "type": "string",
          "description": "The timestamp when the comment was created.",
          "format": "date-time"
        }
      },
      "required": ["text", "authorId", "authorName", "authorRole", "createdAt"]
    },
    "SubmissionStatus": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "SubmissionStatus",
      "type": "object",
      "description": "Represents the status of a submission in the approval workflow.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the SubmissionStatus entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the submission status (e.g., Submitted, Approved by Unit ODIMO, Rejected)."
        },
        "description": {
          "type": "string",
          "description": "Description of the status."
        }
      },
      "required": [
        "id",
        "name",
        "description"
      ]
    },
    "Cycle": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Cycle",
      "type": "object",
      "description": "Represents a submission cycle (First or Final).",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Cycle entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the cycle (e.g., First, Final)."
        },
        "startDate": {
          "type": "string",
          "description": "Start date of the submission cycle.",
          "format": "date-time"
        },
        "endDate": {
          "type": "string",
          "description": "End date of the submission cycle.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "name",
        "startDate",
        "endDate"
      ]
    },
    "Campus": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Campus",
      "type": "object",
      "description": "Represents a campus within the RSU system.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Campus entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the campus."
        },
        "location": {
          "type": "string",
          "description": "Location of the campus."
        }
      },
      "required": [
        "id",
        "name",
        "location"
      ]
    },
    "Unit": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Unit",
      "type": "object",
      "description": "Represents a unit within a campus.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Unit entity."
        },
        "name": {
          "type": "string",
          "description": "Name of the unit."
        },
        "vicePresidentId": {
          "type": "string",
          "description": "The UID of the Vice President this unit reports to. Optional."
        },
        "campusIds": {
            "type": "array",
            "description": "A list of campus IDs this unit belongs to.",
            "items": { "type": "string" }
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "CampusSetting": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "CampusSetting",
      "type": "object",
      "description": "Represents settings specific to a campus.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the CampusSetting entity, same as campusId."
        },
        "announcement": {
          "type": "string",
          "description": "A campus-specific announcement to be displayed on the dashboard."
        }
      },
      "required": [
        "id"
      ]
    },
    "ActivityLog": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "ActivityLog",
      "type": "object",
      "description": "Represents a single logged user action for auditing.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the ActivityLog entity."
        },
        "userId": {
          "type": "string",
          "description": "The UID of the user who performed the action."
        },
        "userName": {
          "type": "string",
          "description": "Denormalized name of the user for easy display."
        },
        "userRole": {
          "type": "string",
          "description": "Denormalized role of the user at the time of the action."
        },
        "action": {
          "type": "string",
          "description": "A short, machine-readable description of the action (e.g., 'user_login', 'create_submission')."
        },
        "details": {
          "type": "object",
          "description": "A flexible object to store additional context about the action.",
          "properties": {
             "submissionId": { "type": "string" },
             "reportType": { "type": "string" },
             "affectedUserId": { "type": "string" }
          }
        },
        "timestamp": {
          "type": "string",
          "description": "The server timestamp when the action occurred.",
          "format": "date-time"
        }
      },
      "required": ["id", "userId", "userName", "userRole", "action", "timestamp"]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "User",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Stores user profile data. Includes denormalized 'role', 'campusId', and 'unitId' for easier access in security rules.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user, matching request.auth.uid."
            }
          ]
        }
      },
      {
        "path": "/submissions/{submissionId}",
        "definition": {
            "entityName": "Submission",
            "schema": { "$ref": "#/backend/entities/Submission" },
            "description": "Stores all report submissions in a single top-level collection. Documents include denormalized 'userId', 'campusId', and 'unitId' to allow for efficient security rules without needing cross-collection 'get' calls during list operations.",
            "params": [
                {
                    "name": "submissionId",
                    "description": "The unique identifier of the submission."
                }
            ]
        }
      },
      {
        "path": "/roles/{roleId}",
        "definition": {
          "entityName": "Role",
          "schema": {
            "$ref": "#/backend/entities/Role"
          },
          "description": "Stores role definitions (e.g., Admin, Campus Director, Employee).",
          "params": [
            {
              "name": "roleId",
              "description": "The unique identifier of the role."
            }
          ]
        }
      },
      {
        "path": "/submissionStatuses/{statusId}",
        "definition": {
          "entityName": "SubmissionStatus",
          "schema": {
            "$ref": "#/backend/entities/SubmissionStatus"
          },
          "description": "Stores the possible statuses of a submission (e.g., Submitted, Approved, Rejected).",
          "params": [
            {
              "name": "statusId",
              "description": "The unique identifier of the submission status."
            }
          ]
        }
      },
      {
        "path": "/cycles/{cycleId}",
        "definition": {
          "entityName": "Cycle",
          "schema": {
            "$ref": "#/backend/entities/Cycle"
          },
          "description": "Stores submission cycle definitions (e.g., First Cycle, Final Cycle).",
          "params": [
            {
              "name": "cycleId",
              "description": "The unique identifier of the cycle."
            }
          ]
        }
      },
      {
        "path": "/campuses/{campusId}",
        "definition": {
          "entityName": "Campus",
          "schema": {
            "$ref": "#/backend/entities/Campus"
          },
          "description": "Stores campus information.",
          "params": [
            {
              "name": "campusId",
              "description": "The unique identifier of the campus."
            }
          ]
        }
      },
       {
        "path": "/campusSettings/{campusId}",
        "definition": {
          "entityName": "CampusSetting",
          "schema": {
            "$ref": "#/backend/entities/CampusSetting"
          },
          "description": "Stores campus-specific settings. The document ID is the same as the campusId.",
          "params": [
            {
              "name": "campusId",
              "description": "The unique identifier of the campus."
            }
          ]
        }
      },
      {
        "path": "/units/{unitId}",
        "definition": {
          "entityName": "Unit",
          "schema": {
            "$ref": "#/backend/entities/Unit"
          },
          "description": "Stores unit information within a campus.",
          "params": [
            {
              "name": "unitId",
              "description": "The unique identifier of the unit."
            }
          ]
        }
      },
      {
        "path": "/activityLogs/{logId}",
        "definition": {
          "entityName": "ActivityLog",
          "schema": { "$ref": "#/backend/entities/ActivityLog" },
          "description": "Stores an immutable record of user actions for auditing purposes. Write-only for users, read-only for admins.",
          "params": [
            {
              "name": "logId",
              "description": "The unique identifier of the log entry."
            }
          ]
        }
      },
      {
        "path": "/roles_admin/{userId}",
        "definition": {
          "entityName": "adminRole",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Documents in this collection denote admin privileges.  Authorization rules check for the existence of a document with the user's UID in this collection. Existence, not content, is important.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who is an admin."
            }
          ]
        }
      },
      {
        "path": "/roles_campus_odimo/{userId}",
        "definition": {
          "entityName": "campusOdimoRole",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Documents in this collection denote Campus ODIMO privileges. Authorization rules check for the existence of a document with the user's UID in this collection. Existence, not content, is important.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who is a campus ODIMO."
            }
          ]
        }
      },
      {
        "path": "/roles_unit_odimo/{userId}",
        "definition": {
          "entityName": "unitOdimoRole",
          "schema": {
            "$ref": "#/backend/entities/User"
          },
          "description": "Documents in this collection denote Unit ODIMO privileges. Authorization rules check for the existence of a document with the user's UID in this collection. Existence, not content, is important.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user who is a unit ODIMO."
            }
          ]
        }
      }
    ],
    "reasoning": "This Firestore structure prioritizes security, scalability, and query performance. The key change is moving submissions to a top-level collection, which simplifies queries for administrative and supervisory roles. This avoids the need for collection group queries for most common scenarios, making the rules and application logic more straightforward.\n\n**Top-Level Submissions:** The `/submissions/{submissionId}` collection allows admins and supervisors to easily query across all submissions (e.g., `where('statusId', '==', 'submitted')`) without needing a `collectionGroup` index. Security is maintained by embedding ownership and context fields (`userId`, `campusId`, `unitId`) directly into each submission document. Security rules can then use these fields to enforce access control.\n\n**Authorization Independence:** Access control is still enforced at the document level. Security rules check the `userId` in the submission document against the authenticated user's UID for ownership-based permissions. For supervisors, rules check the submission's `campusId` or `unitId` against the supervisor's own profile data (fetched via a `get()` call in the rule), ensuring they can only access submissions within their scope.\n\n**DBAC (Database-Based Access Control):** User roles and campus/unit assignments stored in the `/users` collection remain the source of truth for authorization. Helper functions in the security rules (`isAdmin()`, `isCampusOdimo()`, etc.) continue to provide a clear and secure way to check a user's role.\n\n**Denormalization:** The `submissions` collection relies on denormalization of `userId`, `campusId`, `unitId`, and `unitName`. This is critical for writing efficient security rules that do not require joins or multiple `get()` calls to check permissions, which is a key performance best practice for Firestore.\n\n**Invariants:** The structure ensures the integrity of ownership and denormalized data. Security rules on `create` and `update` for the `/submissions` collection will enforce that the `userId` matches the authenticated user and that the denormalized fields like `campusId` and `unitId` match the user's profile, preventing tampering."
  }
}
